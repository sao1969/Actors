const Apify = require('apify');

Apify.main(async () => {
    // Open a request queue and add the search URL for your specific product.
    const requestQueue = await Apify.openRequestQueue();
    await requestQueue.addRequest({ 
        url: 'https://www.woolworths.com.au/shop/search/products?searchTerm=Tim+Tam' 
    });

    // Set up the Puppeteer Crawler 
    const crawler = new Apify.PuppeteerCrawler({
        requestQueue,
        handlePageFunction: async ({ request, page }) => {
            console.log(`Processing ${request.url}...`);

            // Wait for product tiles to load; adjust the selector and timeout as needed
            await page.waitForSelector('.product-tile-price .primary', { timeout: 10000 });

            // Evaluate the page to extract product details
            const products = await page.$$eval('.product-tile', (tiles) => {
                return tiles.map(tile => {
                    const titleEl = tile.querySelector('.product-title-container .title a');
                    const priceEl = tile.querySelector('.product-tile-price .primary');
                    const discountEl = tile.querySelector('.product-tile-promo-info .html-content span');

                    return {
                        title: titleEl ? titleEl.innerText.trim() : null,
                        price: priceEl ? priceEl.innerText.trim() : null,
                        discount: discountEl ? discountEl.innerText.trim() : null,
                    };
                });
            });
            
            console.log('Extracted Products:', products);
            // Push the extracted data to the default dataset
            await Apify.pushData(products);
        },
        handleFailedRequestFunction: async ({ request }) => {
            console.log(`Request ${request.url} failed too many times.`);
        },
    });

    // Run the crawler
    await crawler.run();
});
